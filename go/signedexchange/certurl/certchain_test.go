package certurl_test

import (
	"bytes"
	"io/ioutil"
	"testing"

	. "github.com/WICG/webpackage/go/signedexchange/certurl"
	"github.com/WICG/webpackage/go/signedexchange"
	"github.com/WICG/webpackage/go/signedexchange/internal/testhelper"
)

func createCertChain(t *testing.T) CertChain {
	in, err := ioutil.ReadFile("test-cert.pem")
	if err != nil {
		t.Fatalf("Cannot read test-cert.pem: %v", err)
	}
	certs, err := signedexchange.ParseCertificates(in)
	if err != nil {
		t.Fatalf("Cannot parse test-cert.pem: %v", err)
	}
	chain, err := NewCertChain(certs, []byte("OCSP"), []byte("SCT"))
	if err != nil {
		t.Fatalf("NewCertChain failed: %v", err)
	}
	return chain
}

func TestParsePEM(t *testing.T) {
	want := "[\"üìú‚õì\" map[\"cert\":\"0\\x82\\x05\\xf20\\x82\\x04⁄†\\x03\\x02\\x01\\x02\\x02\\x10\\x0ed\\xc5\\xfb\\xc26\\xad\\xe1K\\x17*\\xebA«å\\xb00\\r\\x06\\t*\\x86H\\x86\\xf7\\r\\x01\\x01\\v\\x05\\x000p1\\v0\\t\\x06\\x03U\\x04\\x06\\x13\\x02US1\\x150\\x13\\x06\\x03U\\x04\\n\\x13\\fDigiCert Inc1\\x190\\x17\\x06\\x03U\\x04\\v\\x13\\x10www.digicert.com1/0-\\x06\\x03U\\x04\\x03\\x13&DigiCert SHA2 High Assurance Server CA0\\x1e\\x17\\r151103000000Z\\x17\\r181128120000Z0\\x81\\xa51\\v0\\t\\x06\\x03U\\x04\\x06\\x13\\x02US1\\x130\\x11\\x06\\x03U\\x04\\b\\x13\\nCalifornia1\\x140\\x12\\x06\\x03U\\x04\\a\\x13\\vLos Angeles1<0:\\x06\\x03U\\x04\\n\\x133Internet Corporation for Assigned Names and Numbers1\\x130\\x11\\x06\\x03U\\x04\\v\\x13\\nTechnology1\\x180\\x16\\x06\\x03U\\x04\\x03\\x13\\x0fwww.example.org0\\x82\\x01\\\"0\\r\\x06\\t*\\x86H\\x86\\xf7\\r\\x01\\x01\\x01\\x05\\x00\\x03\\x82\\x01\\x0f\\x000\\x82\\x01\\n\\x02\\x82\\x01\\x01\\x00\\xb3@\\x96/ac>%\\xc1\\x97\\xadeE\\xfb\\xef\\x13B\\xb3,\\x99\\x86\\xf4\\xb5\\x80\\vv\\xdc\\x068,\\x1f\\xa3bUZ6vﬁÆ]\\xfc\\xe2\\xe5\\xb4\\xe6\\xec]\\xca\\xee\\xca\\xdfP\\x16$,\\xee\\xfc\\x9a\\xb6\\x8c\\xf6\\xa8\\xb3\\xacz\\b{*\\x1f\\xad_\\xe7\\xfa\\x96Y%\\xab\\x90\\xb0\\xf8\\xc2?\\x13\\x04&th\\x0f\\xc6x*\\x95\\x8a_B\\xf2\\x0e\\xedR\\xa6\\xebh#\\x89\\xe5C\\xf8m\\x12\\x1bbB{\\xa8\\x05\\xf3Y\\xc4^\\xd6\\xc5\\xccF\\xc0K\\x19\\xb9-Jqr$\\x1e^UD\\x93\\xabx\\xa1GM\\xa5\\xdc\\aZ\\x9cg\\xf4\\x11h\\x12/\\xd3(q\\xbc\\xadr\\x05<\\x16u\\xd4\\xf8rX\\xba\\x19\\xf1\\xdc\\t\\xed\\xf1\\x18∆í/}\\xbc\\x16\\v7\\x8d\\x8a\\xef\\x1boO\\xb9\\xe0zT\\x98\\xbf\\xb5\\xb6œª\\xaa\\x93\\u007f\\n\\u007f\\x1fV\\xeb\\xa9\\xd8\\xe1\\xdb\\xd59\\xd8\\x18[\\xd1\\xf2d3\\xd0\\xd6\\xc4#\\xff\\t\\xabmq\\xce\\xda\\xcf\\xc1\\x17\\x9c#\\xbe,\\xaf/\\x92\\x1c?\\x90\\b\\x89X\\xf2\\xb1\\xe1\\x10o\\x83.\\xf7\\x9f\\x02\\x03\\x01\\x00\\x01\\xa3\\x82\\x02P0\\x82\\x02L0\\x1f\\x06\\x03U\\x1d#\\x04\\x180\\x16\\x80\\x14Qh\\xff\\x90\\xaf\\x02\\au<\\xcc\\xd9edb\\xa2\\x12\\xb8Yr;0\\x1d\\x06\\x03U\\x1d\\x0e\\x04\\x16\\x04\\x14\\xa6O`\\x1e\\x1f-\\xd1\\xe7\\xf1#\\xa0*\\x95\\x16\\xe4\\xe8\\x9a\\xeanH0\\x81\\x81\\x06\\x03U\\x1d\\x11\\x04z0x\\x82\\x0fwww.example.org\\x82\\vexample.com\\x82\\vexample.edu\\x82\\vexample.net\\x82\\vexample.org\\x82\\x0fwww.example.com\\x82\\x0fwww.example.edu\\x82\\x0fwww.example.net0\\x0e\\x06\\x03U\\x1d\\x0f\\x01\\x01\\xff\\x04\\x04\\x03\\x02\\x05\\xa00\\x1d\\x06\\x03U\\x1d%\\x04\\x160\\x14\\x06\\b+\\x06\\x01\\x05\\x05\\a\\x03\\x01\\x06\\b+\\x06\\x01\\x05\\x05\\a\\x03\\x020u\\x06\\x03U\\x1d\\x1f\\x04n0l04\\xa02\\xa00\\x86.http://crl3.digicert.com/sha2-ha-server-g4.crl04\\xa02\\xa00\\x86.http://crl4.digicert.com/sha2-ha-server-g4.crl0L\\x06\\x03U\\x1d \\x04E0C07\\x06\\t`\\x86H\\x01\\x86\\xfdl\\x01\\x010*0(\\x06\\b+\\x06\\x01\\x05\\x05\\a\\x02\\x01\\x16\\x1chttps://www.digicert.com/CPS0\\b\\x06\\x06g\\x81\\f\\x01\\x02\\x020\\x81\\x83\\x06\\b+\\x06\\x01\\x05\\x05\\a\\x01\\x01\\x04w0u0$\\x06\\b+\\x06\\x01\\x05\\x05\\a0\\x01\\x86\\x18http://ocsp.digicert.com0M\\x06\\b+\\x06\\x01\\x05\\x05\\a0\\x02\\x86Ahttp://cacerts.digicert.com/DigiCertSHA2HighAssuranceServerCA.crt0\\f\\x06\\x03U\\x1d\\x13\\x01\\x01\\xff\\x04\\x020\\x000\\r\\x06\\t*\\x86H\\x86\\xf7\\r\\x01\\x01\\v\\x05\\x00\\x03\\x82\\x01\\x01\\x00\\x84\\xa8\\x9a\\x11\\xa7ÿΩ\\v&~R${\\xb2U\\x9d\\xea0\\x89Q\\b\\x87o\\xa9\\xed\\x10\\xea[>\\v\\xc7-G\\x04N\\xddE7\\xc7 º8\\u007f\\xb6j\\x1ceBjst.Z\\x97\\x85\\xd0Ãí\\xe2.8\\x89\\xd9\\ri\\xfa\\x1b\\x9b\\xf0\\xc1b2eO=\\x98\\xdb\\xda\\xd6f\\xda*VV\\xe3\\x113\\xec\\xe0\\xa5\\x15L\\xeauI\\xf4]\\xef\\x15\\xf5\\x12\\x1c\\xe6\\xf8\\xfc\\x9b\\x04!K\\xcfc\\xe7|\\xfc\\xaa\\xdc\\xfaC\\xd0\\xc0\\xbb\\xf2\\x89\\xea\\x91mÀÖ\\x8ej\\x9f\\xc8\\xf9\\x94\\xbfU=B\\x828M\\b\\xa4\\xa7\\x0e\\xd3eM3a\\x90\\r?\\x80\\xbf\\x82>\\x11Àè?\\xcey\\x94i\\x1b\\xf2\\xdaK»ó\\xb8\\x11Cmj%2\\xb9\\xb2\\xea\\\"b\\x86\\r\\xa3r}O\\xeaW<e;/'s\\xfc|\\x16\\xfb\\r\\x03\\xa4\\n\\xed\\x01\\xab\\xa4#∆ç_\\x8a!\\x15B\\x92\\xc04\\xa2 \\x85\\x88X\\x98\\x89\\x19\\xb1\\x1e \\xed\\x13 \\\\\\x04UdŒù\\xb3e\\xfd\\xf6\\x8f^\\x999!\\x15\\xe2q\\xaaj\\x88\\x82\" \"ocsp\":\"OCSP\" \"sct\":\"SCT\"] map[\"cert\":\"0\\x82\\x04\\xb10\\x82\\x03\\x99\\xa0\\x03\\x02\\x01\\x02\\x02\\x10\\x04\\xe1\\xe7\\xa4\\xdc\\\\\\xf2\\xf3m\\xc0+B\\xb8]\\x15\\x9f0\\r\\x06\\t*\\x86H\\x86\\xf7\\r\\x01\\x01\\v\\x05\\x000l1\\v0\\t\\x06\\x03U\\x04\\x06\\x13\\x02US1\\x150\\x13\\x06\\x03U\\x04\\n\\x13\\fDigiCert Inc1\\x190\\x17\\x06\\x03U\\x04\\v\\x13\\x10www.digicert.com1+0)\\x06\\x03U\\x04\\x03\\x13\\\"DigiCert High Assurance EV Root CA0\\x1e\\x17\\r131022120000Z\\x17\\r281022120000Z0p1\\v0\\t\\x06\\x03U\\x04\\x06\\x13\\x02US1\\x150\\x13\\x06\\x03U\\x04\\n\\x13\\fDigiCert Inc1\\x190\\x17\\x06\\x03U\\x04\\v\\x13\\x10www.digicert.com1/0-\\x06\\x03U\\x04\\x03\\x13&DigiCert SHA2 High Assurance Server CA0\\x82\\x01\\\"0\\r\\x06\\t*\\x86H\\x86\\xf7\\r\\x01\\x01\\x01\\x05\\x00\\x03\\x82\\x01\\x0f\\x000\\x82\\x01\\n\\x02\\x82\\x01\\x01\\x00\\xb6\\xe0/\\xc2$\\x06\\xc8m\\x04_\\xd7\\xef\\nd\\x06\\xb2}\\\"&e\\x16\\xaeB@\\x9b\\xce‹ü\\x9fv\\a>\\xc30U\\x87\\x19\\xb9O\\x94\\x0eZ\\x94\\x1fUV\\xb4\\xc2\\x02*\\xaf–ò\\xee\\v@\\xd7\\xc4\\xd0;r\\xc8\\x14\\x9e\\uf431\\x11\\xa9\\xae\\xd2»∏C:\\xd9\\v\\v\\xd5’ï\\xf5@\\xaf\\xc8\\x1d\\xedM\\x9c_W\\xb7\\x86Ph\\x99\\xf5\\x8a\\xda\\xd2\\xc7\\x05\\x1f\\xa8\\x97\\xc9‹§\\xb1\\x82\\x84-∆≠\\xa5\\x9c\\xc7\\x19\\x82\\xa6\\x85\\x0f^DX*7\\x8f\\xfd5\\xf1\\v\\b'2Z\\xf5\\xbb\\x8b\\x9e\\xa4\\xbdQ\\xd0'\\xe2\\xdd;B3\\xa3\\x05(ƒª(Ãö\\xac+#\\rx\\xc6{\\xe6^q\\xb7J>\\b\\xfb\\x81\\xb7\\x16\\x16\\xa1\\x9d#\\x12M\\xe5◊í\\b\\xacu\\xa4\\x9c\\xba\\xcd\\x17\\xb2\\x1eD5e\\u007fS%9\\xd1\\x1c\\n\\x9ac\\x1b\\x19\\x92th\\n7\\xc2\\xc2RH\\xcb9Z\\xa2\\xb6\\xe1]\\xc1›† \\xb8!\\xa2\\x93&o\\x14J!A\\xc7\\xedm\\x9b\\xf2H/\\xf3\\x03\\xf5\\xa2h\\x92S/^\\xe3\\x02\\x03\\x01\\x00\\x01\\xa3\\x82\\x01I0\\x82\\x01E0\\x12\\x06\\x03U\\x1d\\x13\\x01\\x01\\xff\\x04\\b0\\x06\\x01\\x01\\xff\\x02\\x01\\x000\\x0e\\x06\\x03U\\x1d\\x0f\\x01\\x01\\xff\\x04\\x04\\x03\\x02\\x01\\x860\\x1d\\x06\\x03U\\x1d%\\x04\\x160\\x14\\x06\\b+\\x06\\x01\\x05\\x05\\a\\x03\\x01\\x06\\b+\\x06\\x01\\x05\\x05\\a\\x03\\x0204\\x06\\b+\\x06\\x01\\x05\\x05\\a\\x01\\x01\\x04(0&0$\\x06\\b+\\x06\\x01\\x05\\x05\\a0\\x01\\x86\\x18http://ocsp.digicert.com0K\\x06\\x03U\\x1d\\x1f\\x04D0B0@\\xa0>\\xa0<\\x86:http://crl4.digicert.com/DigiCertHighAssuranceEVRootCA.crl0=\\x06\\x03U\\x1d \\x0460402\\x06\\x04U\\x1d \\x000*0(\\x06\\b+\\x06\\x01\\x05\\x05\\a\\x02\\x01\\x16\\x1chttps://www.digicert.com/CPS0\\x1d\\x06\\x03U\\x1d\\x0e\\x04\\x16\\x04\\x14Qh\\xff\\x90\\xaf\\x02\\au<\\xcc\\xd9edb\\xa2\\x12\\xb8Yr;0\\x1f\\x06\\x03U\\x1d#\\x04\\x180\\x16\\x80\\x14\\xb1>\\xc3i\\x03\\xf8\\xbfG\\x01‘ò&\\x1a\\b\\x02\\xefcd+\\xc30\\r\\x06\\t*\\x86H\\x86\\xf7\\r\\x01\\x01\\v\\x05\\x00\\x03\\x82\\x01\\x01\\x00\\x18\\x8a\\x95\\x89\\x03\\xe6m\\xdf\\\\\\xfc\\x1dh\\xeaJ\\x8f\\x83\\xd6Q/\\x8dkD\\x16\\x9e\\xacc\\xf5\\xd2nl\\x84\\x99\\x8b\\xaa\\x81q\\x84[\\xed4N\\xb0\\xb7y\\x92)\\xcc-\\x80j\\xf0\\x8e \\xe1y\\xa4\\xfe\\x03G\\x13\\xea\\xf5\\x86\\xcaYq}\\xf4\\x04\\x96k\\xd3YX=\\xfe\\xd31%\\\\\\x188\\x84\\xa3ÊüÇ\\xfd\\x8c[\\x981N\\xcdx\\x9e\\x1a\\xfd\\x85\\xcbI\\xaa\\xf2'\\x8b\\x99r\\xfc>\\xaa\\xd5A\\v\\xda\\xd56\\xa1\\xbf\\x1cnGI\\u007f^\\xd9H|\\x03\\xd9\\xfd\\x8bI\\xa0\\x98&B@\\xeb÷í\\x11\\xa4d\\nWT\\xc4\\xf5\\x1d\\xd6\\x02^k\\xac\\xeeƒÄ\\x9a\\x12r\\xfaV\\x93\\xd7\\xff\\xbf0\\x85\\x060\\xbf\\v\\u007fN\\xffW\\x05\\x9d$\\xed\\x85\\xc3+\\xfb\\xa6u\\xa8\\xac-\\x16\\xef}y'\\xb2\\xeb\\u009d\\v\\aÍ™Ö\\xd3\\x01\\xa3 (AYC(“Å\\xe3\\xaa\\xf6\\xec{;w\\xb6@b\\x80\\x05AE\\x01\\xef\\x17\\x06>\\xde\\xc03\\x9bg\\xd3a.r\\x87\\xe4i\\xfc\\x12\\x00W@\\x1ep\\xf5\\x1e…¥\"]]"

	certChain := createCertChain(t)

	buf := &bytes.Buffer{}
	if err := certChain.Write(buf); err != nil {
		t.Fatal(err)
	}
	got, err := testhelper.CborBinaryToReadableString(buf.Bytes())
	if err != nil {
		t.Fatal(err)
	}
	if got != want {
		t.Errorf("CertificateMessageFromPEM:\ngot: %q,\nwant: %q", got, want)
	}
}

func TestRoundtrip(t *testing.T) {
	original := createCertChain(t)
	buf := &bytes.Buffer{}
	if err := original.Write(buf); err != nil {
		t.Fatal(err)
	}

	parsed, err := ReadCertChain(buf)
	if err != nil {
		t.Fatal(err)
	}

	if len(original) != len(parsed) {
		t.Fatalf("Cert chain length differs: want %d, got %d", len(original), len(parsed))
	}
	for i := 0; i < len(original); i++ {
		want := original[i]
		got := parsed[i]
		if !bytes.Equal(want.Cert.Raw, got.Cert.Raw) {
			t.Errorf("Cert at position %d differs:\n want: %v\n got: %v", i, want.Cert.Raw, got.Cert.Raw)
		}
		if !bytes.Equal(want.OCSPResponse, got.OCSPResponse) {
			t.Errorf("OCSP at position %d differs:\n want: %v\n got: %v", i, want.OCSPResponse, got.OCSPResponse)
		}
		if !bytes.Equal(want.SCTList, got.SCTList) {
			t.Errorf("SCT at position %d differs:\n want: %v\n got: %v", i, want.SCTList, got.SCTList)
		}
	}
}
